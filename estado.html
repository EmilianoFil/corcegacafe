<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tu Cafecito</title>
  <link rel="stylesheet" href="css/style.css" />
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NXMC00DZ81"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-NXMC00DZ81');
  </script>
</head>
<body>
  <div id="loader">
    <img src="caballo-logo.png" alt="Cargando..." class="galope">
  </div>

  <div class="menu-style" id="contenedor" style="display:none;">
    <p id="cliente"></p>
    <h1>COMPLET√Å LAS VISITAS Y TE REGALAMOS<br><span style="font-size: 26px; display:block; margin-top: 6px;">UN CAFECITO</span></h1>
    <p id="faltan"></p>
    <div id="grid" class="grid"></div>
    <div id="mensaje-error" style="display:none;"></div>
    <br>
    <a href="index.html" class="btn-secondary">Volver al inicio</a>
    <footer>
      <p>Seguinos en Instagram</p>
      <a href="https://www.instagram.com/corcegacafe" target="_blank">
        <img src="img/instagram.png" alt="Instagram" style="width: 20px; vertical-align: middle; margin-right: 5px;">
        @corcegacafe
      </a>
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      addDoc,
      collection
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC-c_OMJBiPuCfh3bct7cpgSB9LernugRA",
      authDomain: "corcega-loyalty-club.firebaseapp.com",
      projectId: "corcega-loyalty-club",
      storageBucket: "corcega-loyalty-club.firebasestorage.app",
      messagingSenderId: "789184958568",
      appId: "1:789184958568:web:4990bf50335bec365f2bdd",
      measurementId: "G-NXMC00DZ81"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const dni = params.get("dni");

    async function consultarCliente(dni) {
      const ref = doc(db, "clientes", dni);
      const snap = await getDoc(ref);

      document.getElementById("loader").style.display = "none";
      const contenedor = document.getElementById("contenedor");
      contenedor.style.display = "block";

      if (!snap.exists()) {
        document.getElementById("cliente").style.display = "none";
        document.getElementById("faltan").style.display = "none";
        document.getElementById("grid").style.display = "none";
        document.getElementById("mensaje-error").style.display = "block";
        document.getElementById("mensaje-error").innerHTML = `
          <p>El DNI <strong>${dni}</strong> no est√° registrado en nuestro Club de Recompensas.</p>
          <a href="registro.html?dni=${dni}" class="btn-primary">Registrate</a>
        `;
        contenedor.classList.remove("tarjeta-fidelidad");

        await addDoc(collection(db, "logs"), {
          usuario: dni,
          accion: "consulta_fallida",
          detalles: `Consulta fallida: DNI ${dni} no encontrado`,
          timestamp: new Date()
        });

        if (typeof gtag === 'function') {
          gtag('event', 'consulta_fallida', { dni });
        }
        return;
      }

      // Si existe, modo tarjeta fidelidad
      contenedor.classList.add("tarjeta-fidelidad");

      const data = snap.data();

      await addDoc(collection(db, "logs"), {
        usuario: data.dni,
        accion: "consulta_cliente",
        detalles: `Consulta exitosa del cliente ${data.dni} - ${data.nombre}`,
        timestamp: new Date()
      });

      if (typeof gtag === 'function') {
        gtag('event', 'consulta_estado', { dni: data.dni });
      }

      const nombre = data.nombre || "Amigo";
      const cafes = parseInt(data.cafes) || 0;

      document.getElementById("cliente").textContent = `Hola ${nombre}`;
      document.getElementById("faltan").textContent = cafes < 8
        ? `Te faltan ${8 - cafes} para que te invitemos uno.`
        : "¬°El pr√≥ximo lo invitamos nosotros! üêéüéâ";

      const grid = document.getElementById("grid");
      for (let i = 1; i <= 9; i++) {
        const div = document.createElement("div");
        div.className = "circle";

        if (i === 9) {
          div.classList.add("noveno");
        } else if (i <= cafes) {
          div.classList.add("lleno");
        } else {
          div.style.backgroundImage = "url('caballito-claro.png')";
        }

        grid.appendChild(div);
      }
    }

    consultarCliente(dni);
  </script>
</body>
</html>
