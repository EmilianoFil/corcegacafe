<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de EstadÃ­sticas - CÃ³rcega</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #d86634;
      color: #fff;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin-bottom: 10px;
    }

    .card {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 16px;
      margin: 20px auto;
      max-width: 500px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      margin: 5px 0;
    }

    .galope {
      width: 80px;
      animation: galopar 1s infinite ease-in-out alternate;
    }

    @keyframes galopar {
      0% { transform: translateY(0); }
      100% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <div id="loader" style="margin-top: 50px;">
    <img src="caballo-logo.png" alt="Cargando..." class="galope" />
    <p>Cargando datos del club...</p>
  </div>

  <div id="contenedor" style="display:none;">
    <h1>ðŸ“Š EstadÃ­sticas del Club</h1>
    <div class="card" id="resumen"></div>
    <div class="card">
      <h2>â˜• Cafecitos gratis para servir</h2>
      <ul id="cafecitosGratis"></ul>
    </div>
  </div>

  <script type="module">
    import { app, db } from './js/firebase-config.js';
    import { auth, onAuthStateChanged } from './js/firebase-auth.js';
    import { collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      try {
        const q = query(collection(db, "clientes"), orderBy("dni"));
        const querySnapshot = await getDocs(q);
        const clientes = [];

        querySnapshot.forEach(doc => {
          clientes.push(doc.data());
        });

        const total = clientes.length;
        const conCafes = clientes.filter(c => c.cafes > 0).length;
        const conGratis = clientes.filter(c => c.cafe_disponible).length;

        document.getElementById("resumen").innerHTML = `
          Total de clientes: <strong>${total}</strong><br/>
          Con al menos un cafecito: <strong>${conCafes}</strong><br/>
          Con cafecito para servir: <strong>${conGratis}</strong>
        `;

        const listaGratis = clientes
          .filter(c => c.cafe_disponible)
          .sort((a, b) => {
            const tA = a.ultimo_cafe?.toDate?.() ?? new Date(0);
            const tB = b.ultimo_cafe?.toDate?.() ?? new Date(0);
            return tA - tB;
          })
          .map(c => {
            const tiempo = c.ultimo_cafe?.toDate?.() ?? null;
            let haceCuanto = '';
            if (tiempo) {
              const diffMs = Date.now() - tiempo.getTime();
              const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
              haceCuanto = diffDias === 0
                ? ' (hoy)'
                : ` (hace ${diffDias} dÃ­a${diffDias > 1 ? 's' : ''})`;
            }
            return `<li><strong>${c.nombre}</strong> (${c.dni})${haceCuanto}</li>`;
          })
          .join("");

        document.getElementById("cafecitosGratis").innerHTML = listaGratis;
      } catch (e) {
        console.error("Error al cargar estadÃ­sticas:", e);
      } finally {
        document.getElementById("loader").style.display = "none";
        document.getElementById("contenedor").style.display = "block";
      }
    });
  </script>
</body>
</html>
